# Cattery
基本功能介绍：
1.建立调试机制（创建调试进程，附加调试进程）
2.显示/修改汇编代码
3.查看/修改内存数据，查看栈
4.查看/修改寄存器
5.查看调试程序模块信息
6.条件断点
7.反反调试（隐藏PEB，HOOK，关键API）
8.支持插件功能
9.解析被调试程序任意模块的导出表，导入表
10.寄存器断点
11.API断点（有缺陷）
断点功能：
1.软件断点
2.硬件断点（执行，读，写断点）
3.内存访问断点（执行，读，写断点）
4.单步步入
5.单步步过
原理：
1.对于windows来说，CPU为调试做出的硬件支持，而操作系统会捕捉到致使程序崩溃的异常
2.CPU对于调试提供的硬件支持：中断和异常，其中主要是在保护模式下，CPU产生内部中断时就会根据中断向量号的值，在中断描述符表中找到一个处理程序的地址，进而调用这个处理程序，这个表实际上就是一个函数地址数组，被称为中断描述表（IDT），也就是异常处理器（处理回调函数），通常这个函数地址是由操作系统在初始化时填写的
3.了解windows操作系统的这套异常分发机制，操作系统需要找到目标进程，如果目标进程是处于调试状态的，操作系统需要找到目标进程的调试器进程，并将产生异常的信息发送到调试器进程，使用WaitforDebugEvent函数等待调试事件，就能将这些调试信息获取到，异常分发就是操作系统从CPU中接管了异常，再将这个异常根据条件发放到各处
4.当调用创建进程的函数，并传入调试标志的时候，调试子系统便着手准备调试会话，它会为被调试进程的进程内核对象中的调试端口赋值，然后在调试进程的线程内核对象中加入一个调试对象的句柄，这样才会真正的创建被调试进程
5.当被调试进程被创建时，内核的进程创建函数，线程创建函数，模块加载，模块卸载函数都会被一一调用，调试子系统早已在这些内核函数中，当被调用时，就有调试子系统的函数检查创建出来的进程是否被调试，如果被调试，调试子系统的函数就会将进程创建，线程创建，模块加载，等调试事件发送到调试器进程
6.调试器一般分为两个线程，一个是用于等待调试事件的线程，一个是与用户交互的线程。
框架：
1.建立调试会话，调试器提供了两个接口，用于将一个普通的进程编程调试器进程，这两个接口实际上就是创建调试进程或附加进程的API，分别是CreateProcess和DebugActiveProcess
2.接受调试事件，在窗口程序中，程序需要编写一个窗口回调函数以接受窗口消息，在调试器程序中，程序需要调用WaitForDebugEvent函数来等待并接收调试事件，这个函数会使调用它的线程挂起，当调试事件被调试子系统发送过来之后，就会从挂起的状态返回，返回时，携带调试子系统发送过来的调试信息
3.回复调试子系统，调试器在处理完调试事件后，都需要调用ContinueDebugEvent函数来回复调试子系统
4.调试器与用户的交互，和用户的交互一般就是在调试器接收到调试子系统的调试事件后，将对应的信息显示出来，并接收用户的控制命令
命令介绍：
运行程序	g
单步步入	t
单步步过	p
软件断点	bp		
硬件断点	ba	0(执行断点), 1(写) 3(读)	
内存断点 	bm	0读取异常  1写入异常 8执行异常
寄存器	e	修改	ee
堆栈	s	修改	em
内存	m	寄存器断点	cp
模块	mo	API断点	api
修改汇编	ea
条件断点	rp		
解析被调试程序任意模块的导出表和导入表  ei
取消条件断点  crp
功能实现的原理：
1.显示修改汇编代码，通过反汇编引擎将机器码转换出来，而机器码只能是来自被调试进程的机器码，而且需要翻译的机器码，这种机器码必须是当前eip指向的地址上的机器码，因此可以通过获取线程环境快，得到eip，再通过ReadProcessMemory读取eip指向的地址的部分进程内存，再通过反汇编引擎转换就可以了，而修改则是通过汇编引擎转换机器码，通过WriteProcessMemory写入即可
2.显示修改内存数据，则是通过ReadProcessMemory和WriteProcessMemory，查看栈则是通过线程上下文获取ESP，将esp中的值作为内存地址，再通过ReadProcessMemory把栈中的数据读取出来
3.查看修改寄存器，通过线程上下文，GetThreadContext获取寄存器的值，通过SetThreadContext去修改
4.查看调试模块信息，通过快照遍历目标进程ID的模块
